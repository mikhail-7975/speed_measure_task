# Сборка и запуск

```
docker compose up -d
docker attach speed_measure_2
cd src/speed_measure/launch
ros2 launch pipeline.launch.py
```
Параллельно в другом терминале должен быть запущен актуальный бэг

# Описаеие этапов решения 
## 0. Конвертация бэга из ros1 в ros2

Были сделаны 3 docker-контейнера
- ros noetiс для открытия исходного бэга
- "мост" - ros1 noetic + ros foxy
- ros foxy для записи ros2-бэга 

## 1. Просмотр бэга, анализ условий

```
Files:             rosbag2_2026_02_10-05_23_19_0.db3
Bag size:          534.9 MiB
Storage id:        sqlite3
Duration:          294.512s
Start:             Feb 10 2026 05:23:23.695 (1770701003.695)
End:               Feb 10 2026 05:28:18.208 (1770701298.208)
Messages:          19031
Topic information: Topic: /clock | Type: rosgraph_msgs/msg/Clock | Count: 0 | Serialization Format: cdr
                   Topic: /apelsin/compressed | Type: sensor_msgs/msg/CompressedImage | Count: 3475 | Serialization Format: cdr
                   Topic: /apelsin/altitude_estimation | Type: std_msgs/msg/Float32 | Count: 5296 | Serialization Format: cdr
                   Topic: /mavros/global_position/compass_hdg | Type: std_msgs/msg/Float64 | Count: 5152 | Serialization Format: cdr
                   Topic: /mavros/battery | Type: sensor_msgs/msg/BatteryState | Count: 5096 | Serialization Format: cdr
                   Topic: /parameter_events | Type: rcl_interfaces/msg/ParameterEvent | Count: 0 | Serialization Format: cdr
                   Topic: /rosout_agg | Type: rcl_interfaces/msg/Log | Count: 6 | Serialization Format: cdr
                   Topic: /rosout | Type: rcl_interfaces/msg/Log | Count: 6 | Serialization Format: cdr
```

Присутствуют 3 стадии полёта:
- подъём с 7 до 20 метров. Скорость подъёма 0.5 м/с
- горизонтальный полёт на высоте 20 метров. Присутствуют колебания по высоте в диапазоне от 19 до 21 м, в конце полёта есть снижение до 18 м
- /apelsin/altitude_estimation - предположительно, высота, предсказанная по изображению с камеры.

<p align="center">
  <img src="readme_data/Screenshot from 2026-02-12 03-43-11.png" alt="Демо работы" width="600"/>
</p>
 
Присутствуют шумы по высоте + есть несколько выбросов в данных

- съёмка видео происходит с гиростабилизированной камеры, направленной вниз. Отклонение оптической оси камеры от вертикали незначительны. В кадре присутствует множество визуальных особенностей, яркость пикселей между двумя соседними изрображениями постоянна. => `возможно применение оптического потока для определения скорости`

<p align="center">
  <img src="readme_data/Screenshot from 2026-02-12 08-15-08.png" alt="Демо работы" width="600"/>
</p>

- при характерном размере автомобиля 5 м визуально скорость движения камеры можно оценить в 1-2 м/с

## 2. Выбор метода

Задача - определить скорость БПЛА

Условия полёта - горизонтальный полёт, изменения высоты незначительные. Вращение по азимуту отсутствует

Наиболее простой в реализации и подходящий под условия метод - оптический поток

Т к нет ограничений по производительности, есть возможность использовать для каждой точки в кадре (dense метод)

### Ограничения по применению
Данный метод определения скорости работает ошибочно:
- при наличии вертикальной скорости
- при вращении по азимуту


## 3. Реализация

Реализованы ноды
- undistortion_node - исправление оптических искажений камеры
- filter_node - фильтрация показаний высоты, осуществляется фильтром Калмана
- optical_flow_node предсказание оптического потока и рассчёт скорости движения исходя из информации о высоте и о характеристиках камеры. Показания скорости также сглажены фильтром Калмана

## 4. Проверка результатов

![alt text](<readme_data/Screenshot from 2026-02-12 08-40-32.png>)

- скорость дрона составляет от 1 до 2 м/с по Y и от 0 до 0.5 м/м по X
- метод нестабильно работает при колебании дрона в окрестности одной точки

## 5. Дальнейшие доработки

Улучшить алгоритм работы можно следующими способами:
- использовать готовую реализацию ORB SLAM
- Считать матрицу гомографии и искать смещение между двумя соседними изображениями. Данный способ будет работать давать меньше ложных результатов при вертикальном подъёме и вращении по азимуту
- отслеживать наличие вращения дрона и учитывать его в рассчёте скорости